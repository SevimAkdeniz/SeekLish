<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Kelime Bulmaca</title>
  <link rel="stylesheet" href="/nav.css">
  <link rel="stylesheet" href="/css/pages/game-pages/puzzle.css">
</head>
<body>

  <%- include('inc/nav') %>

  <main class="container">
    <h2>Kelimeyi Tahmin Et</h2>

    <% if (word) { %>
      <input type="hidden" id="kelimeId" value="<%= word.id %>">
      <div id="board"></div>

      <div style="margin-top: 10px;">
        <input type="text" id="guessInput" maxlength="<%= word.EngWordName.length %>">
        <button onclick="checkGuess()">Tahmin Et</button>
      </div>

      <p id="mesaj"></p>

      <form action="/profile" method="get">
        <button type="submit">üõë Oyunu Bitir</button>
      </form>
    <% } else { %>
      <p>Hen√ºz bilinen kelimeniz yok.</p>
    <% } %>
  </main>

  <% if (word) { %>
  <script>
    let hedefKelime = "<%= word.EngWordName.toLowerCase() %>";
    let hedefKelimeID = document.getElementById("kelimeId").value;
    let harfSayisi = hedefKelime.length;
    const maxTahmin = 6;
    let tahminSayisi = 0;

    const board = document.getElementById("board");
    const mesaj = document.getElementById("mesaj");
    const inputBoxes = [];

    function boardSifirla() {
      board.innerHTML = "";
      inputBoxes.length = 0;

      for (let i = 0; i < maxTahmin; i++) {
        const row = document.createElement("div");
        row.className = "row";
        const cells = [];

        for (let j = 0; j < harfSayisi; j++) {
          const cell = document.createElement("input");
          cell.className = "cell";
          cell.disabled = true;
          row.appendChild(cell);
          cells.push(cell);
        }

        inputBoxes.push(cells);
        board.appendChild(row);
      }
    }

    boardSifirla();

    async function checkGuess() {
      const input = document.getElementById("guessInput");
      const tahmin = input.value.toLowerCase();
      if (tahmin.length !== harfSayisi) return alert(`${harfSayisi} harfli kelime gir!`);

      const cells = inputBoxes[tahminSayisi];
      for (let i = 0; i < harfSayisi; i++) {
        cells[i].value = tahmin[i];
        if (tahmin[i] === hedefKelime[i]) {
          cells[i].classList.add("correct");
        } else if (hedefKelime.includes(tahmin[i])) {
          cells[i].classList.add("exist");
        } else {
          cells[i].classList.add("wrong");
        }
      }

      tahminSayisi++;

      if (tahmin === hedefKelime || tahminSayisi >= maxTahmin) {
        mesaj.innerText = tahmin === hedefKelime
          ? "‚úÖ Doƒüru! Yeni kelime geliyor..."
          : "‚ùå Bilemedin. Yeni kelime geliyor...";

        const response = await fetch('/puzzle-tahmin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tahmin, hedef: hedefKelime })
        });

        const data = await response.json();

        if (data.bitti) {
          mesaj.innerText = "üéâ T√ºm kelimeleri √ß√∂zd√ºn!";
          return;
        }

        hedefKelime = data.yeniKelime;
        hedefKelimeID = data.yeniKelimeID;
        harfSayisi = hedefKelime.length;
        document.getElementById("guessInput").setAttribute("maxlength", harfSayisi);

        tahminSayisi = 0;
        input.value = "";
        boardSifirla(); 
      } else {
        input.value = "";
      }
    }
  </script>
  <% } %>
</body>
</html>
